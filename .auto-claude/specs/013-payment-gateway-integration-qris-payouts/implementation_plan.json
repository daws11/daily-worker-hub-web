{
  "feature": "Payment Gateway Integration (QRIS & Payouts)",
  "workflow_type": "feature",
  "workflow_rationale": "This is a feature workflow because we are adding new functionality (payment gateway integration with Xendit) that involves multiple services: database schema changes, API integration, webhook handlers, and UI components. The implementation follows service dependency order: database first, then server-side logic, then frontend UI.",
  "phases": [
    {
      "id": "phase-1-database",
      "name": "Database Schema Setup",
      "type": "implementation",
      "description": "Create database tables for wallets, payment transactions, payout requests, and bank accounts with proper RLS policies",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Create wallets table for businesses and workers with balance tracking",
          "service": "database",
          "files_to_create": [
            "supabase/migrations/20250222000006_create_wallets.sql"
          ],
          "files_to_modify": [
            "lib/supabase/types.ts"
          ],
          "patterns_from": [
            "supabase/migrations/20250222000001_initial_schema.sql"
          ],
          "verification": {
            "type": "command",
            "command": "psql $DATABASE_URL -c '\\dt wallets' && echo 'Wallets table exists'",
            "expected": "Wallets table exists"
          },
          "status": "completed"
        },
        {
          "id": "subtask-1-2",
          "description": "Create payment_transactions table for QRIS deposits",
          "service": "database",
          "files_to_create": [
            "supabase/migrations/20250222000007_create_payment_transactions.sql"
          ],
          "files_to_modify": [
            "lib/supabase/types.ts"
          ],
          "patterns_from": [
            "supabase/migrations/20250222000001_initial_schema.sql"
          ],
          "verification": {
            "type": "command",
            "command": "psql $DATABASE_URL -c '\\dt payment_transactions' && echo 'Payment transactions table exists'",
            "expected": "Payment transactions table exists"
          },
          "status": "completed",
          "notes": "Payment transactions table implementation completed. Migration file at supabase/migrations/20250222000007_create_payment_transactions.sql and TypeScript types added to lib/supabase/types.ts. Table includes QRIS-specific fields, proper RLS policies, and follows the same patterns as initial_schema.sql.",
          "updated_at": "2026-02-22T07:48:10.378784+00:00"
        },
        {
          "id": "subtask-1-3",
          "description": "Create payout_requests table for worker withdrawals with fee tracking",
          "service": "database",
          "files_to_create": [
            "supabase/migrations/20250222000008_create_payout_requests.sql"
          ],
          "files_to_modify": [
            "lib/supabase/types.ts"
          ],
          "patterns_from": [
            "supabase/migrations/20250222000001_initial_schema.sql"
          ],
          "verification": {
            "type": "command",
            "command": "psql $DATABASE_URL -c '\\dt payout_requests' && echo 'Payout requests table exists'",
            "expected": "Payout requests table exists"
          },
          "status": "completed",
          "notes": "Payout requests table implementation completed. Migration file at supabase/migrations/20250222000008_create_payout_requests.sql includes: 1) payout_request_status and bank_code enums, 2) payout_requests table with fee tracking (amount, fee_amount, net_amount), 3) Bank account fields (bank_code, account_number, account_name), 4) Payment provider integration fields, 5) Processing timestamps (requested_at, processed_at, completed_at, failed_at), 6) Proper RLS policies for workers and admins, 7) Helper functions for fee calculation and payout management. TypeScript types added to lib/supabase/types.ts matching the schema. Follows patterns from initial_schema.sql.",
          "updated_at": "2026-02-22T08:00:16.061462+00:00"
        },
        {
          "id": "subtask-1-4",
          "description": "Create bank_accounts table for worker withdrawal destinations",
          "service": "database",
          "files_to_create": [
            "supabase/migrations/20250222000009_create_bank_accounts.sql"
          ],
          "files_to_modify": [
            "lib/supabase/types.ts"
          ],
          "patterns_from": [
            "supabase/migrations/20250222000001_initial_schema.sql"
          ],
          "verification": {
            "type": "command",
            "command": "psql $DATABASE_URL -c '\\dt bank_accounts' && echo 'Bank accounts table exists'",
            "expected": "Bank accounts table exists"
          },
          "status": "completed",
          "notes": "Bank accounts table implementation completed. Migration file at supabase/migrations/20250222000009_create_bank_accounts.sql includes: 1) bank_code enum for Indonesian banks (BCA, BRI, Mandiri, BNI), 2) bank_accounts table with worker_id foreign key, 3) is_primary flag for default account selection, 4) Unique index to ensure only one primary account per worker, 5) Trigger function to enforce single primary account per worker, 6) Comprehensive RLS policies for worker self-service and admin access, 7) Proper indexes for performance (worker_id, bank_code, is_primary, created_at). TypeScript types added to lib/supabase/types.ts matching the schema. Follows all patterns from initial_schema.sql.",
          "updated_at": "2026-02-22T09:01:00.000000+00:00"
        },
        {
          "id": "subtask-1-5",
          "description": "Create RLS policies for payment tables to ensure data security",
          "service": "database",
          "files_to_create": [
            "supabase/migrations/20250222000010_payment_rls_policies.sql"
          ],
          "patterns_from": [
            "supabase/migrations/002_rls_policies.sql",
            "supabase/migrations/20260222_add_bookings_rls_policies.sql"
          ],
          "verification": {
            "type": "command",
            "command": "psql $DATABASE_URL -c \"SELECT policyname FROM pg_policies WHERE tablename IN ('wallets', 'payment_transactions', 'payout_requests', 'bank_accounts');\" | head -10",
            "expected": "Multiple RLS policies found"
          },
          "status": "completed",
          "notes": "Created comprehensive RLS policies migration at supabase/migrations/20250222000010_payment_rls_policies.sql. The migration includes:\n\n1. **Wallets Policies (6 policies)**:\n   - Business owners can read their own wallet\n   - Workers can read their own wallet\n   - Admins have full CRUD access\n\n2. **Payment Transactions Policies (5 policies)**:\n   - Business owners can read their own transactions\n   - Admins have full CRUD access (transactions created via webhooks)\n\n3. **Payout Requests Policies (6 policies)**:\n   - Workers can read and create their own requests\n   - Workers can cancel pending requests before processing\n   - Admins have full access\n\n4. **Bank Accounts Policies (8 policies)**:\n   - Workers have full CRUD on their own accounts\n   - Admins have full access for auditing\n\nAll policies follow established patterns from 002_rls_policies.sql and 20260222_add_bookings_rls_policies.sql:\n- Use EXISTS subqueries for better performance\n- Use text casting (::text) for UUID comparisons\n- Use is_admin() helper function\n- Proper security notes included",
          "updated_at": "2026-02-22T08:11:36.636076+00:00"
        }
      ]
    },
    {
      "id": "phase-2-types-utils",
      "name": "Core Types and Utilities",
      "type": "implementation",
      "description": "Update TypeScript types and create payment utilities including Xendit client and validators",
      "depends_on": [
        "phase-1-database"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Update lib/supabase/types.ts with new payment-related tables",
          "service": "app",
          "files_to_modify": [
            "lib/supabase/types.ts"
          ],
          "patterns_from": [
            "lib/supabase/types.ts"
          ],
          "verification": {
            "type": "command",
            "command": "npm run type-check 2>&1 | grep -i 'error' | wc -l",
            "expected": "0"
          },
          "status": "pending"
        },
        {
          "id": "subtask-2-2",
          "description": "Create lib/types/payment.ts with payment-related TypeScript interfaces",
          "service": "app",
          "files_to_create": [
            "lib/types/payment.ts"
          ],
          "patterns_from": [
            "lib/types/job.ts"
          ],
          "verification": {
            "type": "command",
            "command": "npm run type-check 2>&1 | grep -i 'error' | wc -l",
            "expected": "0"
          },
          "status": "pending"
        },
        {
          "id": "subtask-2-3",
          "description": "Create lib/utils/xendit.ts with Xendit API client functions",
          "service": "app",
          "files_to_create": [
            "lib/utils/xendit.ts"
          ],
          "patterns_from": [
            "lib/utils/currency.ts"
          ],
          "verification": {
            "type": "command",
            "command": "node -e \"const xendit = require('./lib/utils/xendit.ts'); console.log('Xendit module loaded');\" 2>&1 || echo 'Module check complete'",
            "expected": "Module check complete"
          },
          "status": "pending"
        },
        {
          "id": "subtask-2-4",
          "description": "Create lib/utils/payment-validator.ts with validation for amounts and bank accounts",
          "service": "app",
          "files_to_create": [
            "lib/utils/payment-validator.ts"
          ],
          "patterns_from": [
            "lib/validators/worker-profile.ts"
          ],
          "verification": {
            "type": "command",
            "command": "npm run type-check 2>&1 | grep -i 'error' | wc -l",
            "expected": "0"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-3-supabase-queries",
      "name": "Database Query Functions",
      "type": "implementation",
      "description": "Create Supabase query functions for wallets and payment operations",
      "depends_on": [
        "phase-2-types-utils"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Create lib/supabase/queries/wallets.ts with wallet CRUD operations",
          "service": "app",
          "files_to_create": [
            "lib/supabase/queries/wallets.ts"
          ],
          "patterns_from": [
            "lib/supabase/queries/jobs.ts"
          ],
          "verification": {
            "type": "command",
            "command": "npm run type-check 2>&1 | grep -i 'error' | wc -l",
            "expected": "0"
          },
          "status": "pending"
        },
        {
          "id": "subtask-3-2",
          "description": "Create lib/supabase/queries/transactions.ts with payment transaction queries",
          "service": "app",
          "files_to_create": [
            "lib/supabase/queries/transactions.ts"
          ],
          "patterns_from": [
            "lib/supabase/queries/jobs.ts"
          ],
          "verification": {
            "type": "command",
            "command": "npm run type-check 2>&1 | grep -i 'error' | wc -l",
            "expected": "0"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-4-server-actions",
      "name": "Server Actions for Payments",
      "type": "implementation",
      "description": "Create server actions for QRIS payments and worker withdrawals",
      "depends_on": [
        "phase-3-supabase-queries"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Create lib/actions/payments.ts with QRIS payment initialization",
          "service": "app",
          "files_to_create": [
            "lib/actions/payments.ts"
          ],
          "patterns_from": [
            "lib/actions/job-applications.ts",
            "lib/actions/notifications.ts"
          ],
          "verification": {
            "type": "command",
            "command": "npm run type-check 2>&1 | grep -i 'error' | wc -l",
            "expected": "0"
          },
          "status": "pending"
        },
        {
          "id": "subtask-4-2",
          "description": "Add payout request action to lib/actions/payments.ts",
          "service": "app",
          "files_to_modify": [
            "lib/actions/payments.ts"
          ],
          "patterns_from": [
            "lib/actions/job-applications.ts"
          ],
          "verification": {
            "type": "command",
            "command": "npm run type-check 2>&1 | grep -i 'error' | wc -l",
            "expected": "0"
          },
          "status": "pending"
        },
        {
          "id": "subtask-4-3",
          "description": "Add wallet balance check action to lib/actions/payments.ts",
          "service": "app",
          "files_to_modify": [
            "lib/actions/payments.ts"
          ],
          "patterns_from": [
            "lib/actions/notifications.ts"
          ],
          "verification": {
            "type": "command",
            "command": "npm run type-check 2>&1 | grep -i 'error' | wc -l",
            "expected": "0"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-5-webhooks",
      "name": "Webhook Handlers",
      "type": "implementation",
      "description": "Create Supabase Edge Functions to handle payment and payout webhooks from Xendit",
      "depends_on": [
        "phase-4-server-actions"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Create Supabase Edge Function for payment webhook handling",
          "service": "supabase",
          "files_to_create": [
            "supabase/functions/payment-webhook/index.ts"
          ],
          "patterns_from": [
            "supabase/functions/reliability-score/index.ts"
          ],
          "verification": {
            "type": "command",
            "command": "supabase functions deploy payment-webhook --dry-run 2>&1 | grep -i 'payment-webhook' | head -1 || echo 'Function structure verified'",
            "expected": "Function structure verified"
          },
          "status": "pending"
        },
        {
          "id": "subtask-5-2",
          "description": "Create Supabase Edge Function for payout webhook handling",
          "service": "supabase",
          "files_to_create": [
            "supabase/functions/payout-webhook/index.ts"
          ],
          "patterns_from": [
            "supabase/functions/reliability-score/index.ts"
          ],
          "verification": {
            "type": "command",
            "command": "supabase functions deploy payout-webhook --dry-run 2>&1 | grep -i 'payout-webhook' | head -1 || echo 'Function structure verified'",
            "expected": "Function structure verified"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-6-components",
      "name": "Frontend Components",
      "type": "implementation",
      "description": "Create React components for QRIS payment form, withdrawal form, and transaction history",
      "depends_on": [
        "phase-4-server-actions"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-6-1",
          "description": "Create components/payment/qris-payment-form.tsx for business wallet top-up",
          "service": "app",
          "files_to_create": [
            "components/payment/qris-payment-form.tsx"
          ],
          "patterns_from": [
            "components/job-posting-form.tsx",
            "components/ui/form.tsx"
          ],
          "verification": {
            "type": "command",
            "command": "npm run type-check 2>&1 | grep -i 'error' | wc -l",
            "expected": "0"
          },
          "status": "pending"
        },
        {
          "id": "subtask-6-2",
          "description": "Create components/payment/withdrawal-form.tsx for worker withdrawals",
          "service": "app",
          "files_to_create": [
            "components/payment/withdrawal-form.tsx"
          ],
          "patterns_from": [
            "components/worker/file-upload.tsx",
            "components/ui/form.tsx"
          ],
          "verification": {
            "type": "command",
            "command": "npm run type-check 2>&1 | grep -i 'error' | wc -l",
            "expected": "0"
          },
          "status": "pending"
        },
        {
          "id": "subtask-6-3",
          "description": "Create components/payment/transaction-history.tsx to display payment history",
          "service": "app",
          "files_to_create": [
            "components/payment/transaction-history.tsx"
          ],
          "patterns_from": [
            "components/application-list.tsx",
            "components/ui/table.tsx"
          ],
          "verification": {
            "type": "command",
            "command": "npm run type-check 2>&1 | grep -i 'error' | wc -l",
            "expected": "0"
          },
          "status": "pending"
        },
        {
          "id": "subtask-6-4",
          "description": "Create components/payment/wallet-balance.tsx to display wallet balance",
          "service": "app",
          "files_to_create": [
            "components/payment/wallet-balance.tsx"
          ],
          "patterns_from": [
            "components/ui/card.tsx"
          ],
          "verification": {
            "type": "command",
            "command": "npm run type-check 2>&1 | grep -i 'error' | wc -l",
            "expected": "0"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-7-pages",
      "name": "Dashboard Pages",
      "type": "implementation",
      "description": "Create wallet pages for businesses and workers",
      "depends_on": [
        "phase-6-components"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-7-1",
          "description": "Create business wallet page with QRIS top-up and transaction history",
          "service": "app",
          "files_to_create": [
            "app/app/(dashboard)/business/wallet/page.tsx"
          ],
          "patterns_from": [
            "app/app/(dashboard)/business/jobs/page.tsx",
            "app/app/(dashboard)/business/profile/page.tsx"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000/dashboard-business-wallet",
            "checks": [
              "Page renders without errors",
              "Wallet balance displayed",
              "QRIS payment form visible",
              "Transaction history visible"
            ]
          },
          "status": "pending"
        },
        {
          "id": "subtask-7-2",
          "description": "Create worker wallet page with withdrawal form and payout history",
          "service": "app",
          "files_to_create": [
            "app/app/(dashboard)/worker/wallet/page.tsx"
          ],
          "patterns_from": [
            "app/app/(dashboard)/worker/jobs/page.tsx",
            "app/app/(dashboard)/worker/profile/page.tsx"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000/dashboard-worker-wallet",
            "checks": [
              "Page renders without errors",
              "Wallet balance displayed",
              "Withdrawal form visible",
              "Transaction history visible"
            ]
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-8-integration",
      "name": "Integration and Testing",
      "type": "integration",
      "description": "End-to-end testing of payment flow, webhook handling, and error scenarios",
      "depends_on": [
        "phase-5-webhooks",
        "phase-7-pages"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-8-1",
          "description": "Add environment variables for Xendit API credentials to .env.local.example",
          "service": "app",
          "files_to_modify": [
            ".env.local.example"
          ],
          "patterns_from": [
            ".env.local.example"
          ],
          "verification": {
            "type": "command",
            "command": "grep -i 'XENDIT' .env.local.example | wc -l",
            "expected": "3"
          },
          "status": "pending"
        },
        {
          "id": "subtask-8-2",
          "description": "End-to-end verification: Business top-up flow via QRIS",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Business user logs in and navigates to wallet page",
              "Wallet balance is displayed (initially 0)",
              "QRIS payment form accepts valid amount (>= Rp 500.000)",
              "Payment is created with Xendit API",
              "QR code/payment URL is displayed",
              "Simulate successful payment webhook from Xendit",
              "Verify wallet balance is updated in database",
              "Verify transaction is recorded in payment_transactions table",
              "Verify business user sees updated balance"
            ]
          },
          "status": "pending"
        },
        {
          "id": "subtask-8-3",
          "description": "End-to-end verification: Worker withdrawal flow",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Worker user logs in and navigates to wallet page",
              "Worker has sufficient wallet balance (seeded)",
              "Bank account is saved for the worker",
              "Withdrawal form accepts valid amount (>= Rp 100.000)",
              "Fee is calculated correctly (free for first weekly withdrawal)",
              "Payout request is created with Xendit API",
              "Wallet balance is deducted (pending status)",
              "Simulate successful payout webhook from Xendit",
              "Verify payout status is updated to completed"
            ]
          },
          "status": "pending"
        },
        {
          "id": "subtask-8-4",
          "description": "Error handling verification: Failed payments and payouts",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Test QRIS payment with amount below minimum (Rp 500.000)",
              "Verify validation error is shown",
              "Test withdrawal with amount below minimum (Rp 100.000)",
              "Verify validation error is shown",
              "Test withdrawal with insufficient wallet balance",
              "Verify error message is shown",
              "Simulate failed payment webhook from Xendit",
              "Verify transaction status is updated to failed",
              "Verify wallet balance is not affected",
              "Simulate failed payout webhook from Xendit",
              "Verify payout status is updated to failed",
              "Verify wallet balance is refunded"
            ]
          },
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 8,
    "total_subtasks": 29,
    "services_involved": [
      "database",
      "app",
      "supabase"
    ],
    "parallelism": {
      "max_parallel_phases": 3,
      "parallel_groups": [
        {
          "phases": [
            "phase-6-components",
            "phase-7-pages"
          ],
          "reason": "Components phase has independent subtasks, pages depend on components"
        }
      ],
      "recommended_workers": 2,
      "speedup_estimate": "1.5x faster than sequential"
    },
    "startup_command": "npm run dev"
  },
  "verification_strategy": {
    "risk_level": "high",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "unit",
      "integration",
      "e2e"
    ],
    "security_scanning_required": true,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All existing tests pass",
      "New code has test coverage",
      "Payment webhooks are properly authenticated",
      "No API keys are exposed to the browser",
      "RLS policies prevent cross-user data access"
    ],
    "verification_steps": [
      {
        "name": "TypeScript Type Check",
        "command": "npm run type-check",
        "expected_outcome": "No type errors",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "ESLint",
        "command": "npm run lint",
        "expected_outcome": "No linting errors",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Secrets Scan",
        "command": "git grep -i 'sk_live\\|xendit.*secret' -- '*.ts' '*.tsx' | wc -l",
        "expected_outcome": "0 secrets found in source files",
        "type": "security",
        "required": true,
        "blocking": true
      },
      {
        "name": "RLS Policy Verification",
        "command": "psql $DATABASE_URL -c \"SELECT policyname FROM pg_policies WHERE tablename IN ('wallets', 'payment_transactions', 'payout_requests', 'bank_accounts');\" | wc -l",
        "expected_outcome": "At least 4 RLS policies found",
        "type": "test",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "High risk payment integration requires comprehensive testing including security scanning for exposed API keys, RLS policy verification, and end-to-end payment flow testing."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "npm run type-check",
        "npm run lint"
      ],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": [],
      "services_to_test": [
        "app",
        "database"
      ]
    },
    "e2e_tests": {
      "required": true,
      "commands": [],
      "flows": [
        "business-top-up-qris",
        "worker-withdrawal-bank-transfer",
        "failed-payment-handling"
      ]
    },
    "browser_verification": {
      "required": true,
      "pages": [
        {
          "url": "http://localhost:3000/dashboard-business-wallet",
          "checks": [
            "renders",
            "no-console-errors",
            "qris-form-visible"
          ]
        },
        {
          "url": "http://localhost:3000/dashboard-worker-wallet",
          "checks": [
            "renders",
            "no-console-errors",
            "withdrawal-form-visible"
          ]
        }
      ]
    },
    "database_verification": {
      "required": true,
      "checks": [
        "wallets-table-exists",
        "payment_transactions-table-exists",
        "payout_requests-table-exists",
        "bank_accounts-table-exists",
        "rls-policies-applied"
      ]
    },
    "security_verification": {
      "required": true,
      "checks": [
        "no-api-keys-in-client-code",
        "webhook-signature-verification",
        "rls-prevents-cross-user-access"
      ]
    }
  },
  "qa_signoff": null,
  "status": "in_progress",
  "planStatus": "in_progress",
  "xstateState": "backlog",
  "executionPhase": "coding",
  "updated_at": "2026-02-22T08:08:25.445Z",
  "last_updated": "2026-02-22T08:11:36.636090+00:00"
}