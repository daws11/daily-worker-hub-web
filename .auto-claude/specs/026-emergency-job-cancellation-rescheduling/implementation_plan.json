{
  "feature": "Emergency Job Cancellation & Rescheduling",
  "description": "# Emergency Job Cancellation & Rescheduling\n\nEmergency cancellation system allowing workers and businesses to cancel bookings with valid reasons (illness, emergency) and minimal penalties. Includes rescheduling options and notification to affected parties.\n\n## Rationale\nEmergencies happen, and a fair cancellation policy reduces no-shows by allowing workers to cancel properly rather than simply not showing up. This builds trust and understanding in the community.\n\n## User Stories\n- As a worker, I want to cancel if I'm sick so that I don't negatively impact my reliability\n- As a business, I want to know if a worker has an emergency so that I can find a replacement\n- As both parties, I want a fair cancellation policy so that emergencies don't ruin relationships\n\n## Acceptance Criteria\n- [ ] Workers can cancel bookings with emergency reasons\n- [ ] Businesses can cancel bookings with valid reasons\n- [ ] Cancellation reasons are categorized (illness, emergency, etc.)\n- [ ] Minimal penalties apply for emergency cancellations\n- [ ] Rescheduling options are offered when possible\n- [ ] Affected parties are notified immediately\n- [ ] Repeated cancellations affect reliability score\n- [ ] Businesses can leave notes about cancellations",
  "created_at": "2026-02-21T21:45:12.366Z",
  "updated_at": "2026-02-24T14:39:21.566Z",
  "status": "in_progress",
  "workflow_type": "feature",
  "workflow_rationale": "This is a feature workflow because we're adding new functionality (emergency cancellation with reasons) that spans multiple layers: database schema changes, new server actions, and enhanced UI components. The feature has clear dependencies: database must be created before server actions can use it, and server actions must exist before UI can consume them.",
  "phases": [
    {
      "id": "phase-1-database",
      "name": "Database Schema",
      "type": "implementation",
      "description": "Create database schema for cancellation reasons and add cancellation tracking to bookings table",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Create cancellation reasons enum and table",
          "service": "database",
          "files_to_create": [
            "supabase/migrations/20260224_add_emergency_cancellation.sql"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "supabase/migrations/001_initial_schema.sql"
          ],
          "verification": {
            "type": "command",
            "command": "psql $DATABASE_URL -c \"SELECT COUNT(*) FROM cancellation_reasons;\"",
            "expected": "reasons exist in table"
          },
          "status": "completed",
          "notes": "Created cancellation_reason_category enum with 7 categories (illness, family_emergency, personal_emergency, weather, transportation, schedule_conflict, other). Created cancellation_reasons table with proper indexes, RLS policies, and seed data with 13 predefined reasons."
        },
        {
          "id": "subtask-1-2",
          "description": "Add cancellation columns to bookings table",
          "service": "database",
          "files_to_modify": [
            "supabase/migrations/20260224_add_emergency_cancellation.sql"
          ],
          "files_to_create": [],
          "patterns_from": [
            "supabase/migrations/20250222000001_initial_schema.sql"
          ],
          "verification": {
            "type": "command",
            "command": "psql $DATABASE_URL -c \"\\d bookings\" | grep cancellation",
            "expected": "cancellation_reason_id and cancellation_note columns"
          },
          "status": "completed",
          "notes": "Added cancellation_reason_id (FK to cancellation_reasons), cancellation_note (TEXT), and cancelled_at (TIMESTAMPTZ) columns to bookings table. Created indexes for cancellation_reason_id and cancelled_at."
        },
        {
          "id": "subtask-1-3",
          "description": "Add RLS policies for cancellation reasons",
          "service": "database",
          "files_to_modify": [
            "supabase/migrations/20260224_add_emergency_cancellation.sql"
          ],
          "files_to_create": [],
          "patterns_from": [
            "supabase/migrations/002_rls_policies.sql"
          ],
          "verification": {
            "type": "command",
            "command": "psql $DATABASE_URL -c \"SELECT policyname FROM pg_policies WHERE tablename = 'cancellation_reasons';\"",
            "expected": "RLS policies exist"
          },
          "status": "completed",
          "notes": "Added complete RLS policies following pattern from 002_rls_policies.sql: Public read access, Admin insert access, Admin update access, Admin delete access. Cancellation reasons are publicly readable but only admins can modify them."
        },
        {
          "id": "subtask-1-4",
          "description": "Seed cancellation reasons data",
          "service": "database",
          "files_to_modify": [
            "supabase/migrations/20260224_add_emergency_cancellation.sql"
          ],
          "files_to_create": [],
          "patterns_from": [
            "supabase/migrations/003_seed_data.sql"
          ],
          "verification": {
            "type": "command",
            "command": "psql $DATABASE_URL -c \"SELECT name FROM cancellation_reasons ORDER BY penalty_score;\"",
            "expected": "Predefined reasons (illness, emergency, etc.)"
          },
          "status": "completed",
          "notes": "Added seed data for 13 cancellation reasons with explicit ON CONFLICT (id) DO NOTHING clause following pattern from 003_seed_data.sql. Categories include: Illness (0% penalty), Family Emergency (0% penalty), Personal Emergency (0% penalty), Weather (0% penalty), Transportation (10% penalty), Schedule Conflict (25% penalty), Other (25% penalty)."
        }
      ]
    },
    {
      "id": "phase-2-server-actions",
      "name": "Server Actions",
      "type": "implementation",
      "description": "Create server actions for emergency cancellation with notifications and reliability score updates",
      "depends_on": [
        "phase-1-database"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Create cancellations server action file with TypeScript types",
          "service": "frontend",
          "files_to_create": [
            "lib/actions/cancellations.ts"
          ],
          "files_to_modify": [
            "lib/supabase/types.ts"
          ],
          "patterns_from": [
            "lib/actions/job-applications.ts",
            "lib/actions/notifications.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cat lib/actions/cancellations.ts | head -20",
            "expected": "'use server' directive with type definitions"
          },
          "status": "completed",
          "notes": "Created lib/actions/cancellations.ts following patterns from job-applications.ts and notifications.ts. Added cancellation_reason_category enum to types.ts, added cancellation_reasons table type definition, updated bookings table with cancellation columns (cancellation_reason_id, cancellation_note, cancelled_at). Functions created: getActiveCancellationReasons, workerCancelBooking, businessCancelBooking, getCancellationReason, getWorkerCancellationHistory, getBusinessCancellationHistory."
        },
        {
          "id": "subtask-2-2",
          "description": "Implement cancelBookingWithReason function",
          "service": "frontend",
          "files_to_modify": [
            "lib/actions/cancellations.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "lib/actions/job-applications.ts"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review cancelBookingWithReason function has: status update to cancelled, cancellation reason/note storage, notification to affected party"
          },
          "status": "completed",
          "notes": "Implemented cancelBookingWithReason function that: (1) Updates booking status to 'cancelled', (2) Stores cancellation_reason_id and cancellation_note, (3) Sends notification to affected party via createNotification. Function supports both worker and business cancellations via optional parameters. Validates ownership and booking status before allowing cancellation. Follows patterns from job-applications.ts and notifications.ts."
        },
        {
          "id": "subtask-2-3",
          "description": "Implement getWorkerCancellationHistory function",
          "service": "frontend",
          "files_to_modify": [
            "lib/actions/cancellations.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "lib/actions/job-applications.ts"
          ],
          "verification": {
            "type": "command",
            "command": "grep -n 'getWorkerCancellationHistory' lib/actions/cancellations.ts",
            "expected": "Function exists"
          },
          "status": "completed",
          "notes": "Implemented getWorkerCancellationHistory function following pattern from getWorkerApplications. Queries bookings table for cancelled bookings with cancellation reasons, includes related job and business data, orders by cancelled_at descending. Returns standard success/error response with proper error handling."
        },
        {
          "id": "subtask-2-4",
          "description": "Add cancellation types to lib/types/booking.ts",
          "service": "frontend",
          "files_to_create": [
            "lib/types/cancellation.ts"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "lib/types/attendance.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cat lib/types/cancellation.ts | grep -E 'CancellationReason|EmergencyCancellation'",
            "expected": "Type definitions exist"
          },
          "status": "completed",
          "notes": "Created lib/types/cancellation.ts following pattern from lib/types/attendance.ts. Types include: CancellationReasonCategory enum, CancellationInitiator ('worker' | 'business'), CancellationReason interface, CancellationRecord, CancellationWithRelations, CancelBookingData DTO, Worker/BusinessCancelBookingData role-specific data, CancellationStats with emergency/partial penalty tracking, Worker/BusinessCancellationHistory with stats, CancellationListParams/Response for pagination, EmergencyCancellationRequest, and CancellationNotificationData."
        },
        {
          "id": "subtask-2-5",
          "description": "Update reliability score function to account for emergency cancellations",
          "service": "edge_functions",
          "files_to_modify": [
            "supabase/functions/reliability-score/index.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "supabase/functions/reliability-score/index.ts"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify reliability score calculation reduces penalty for emergency cancellations with valid reasons"
          },
          "status": "completed",
          "notes": "Modified reliability-score edge function to account for emergency cancellations: (1) Updated bookings query to join with cancellation_reasons table to get penalty_percentage, (2) Implemented effective completions logic where cancelled bookings contribute based on penalty (0% penalty = 1.0 effective, 10% penalty = 0.9, 25% penalty = 0.75, no reason = 0.0), (3) Added cancellation breakdown tracking (emergency, partial penalty, full penalty), (4) Updated response metrics to include cancellation breakdown. This ensures workers who cancel with valid emergency reasons are not unfairly penalized in their reliability score."
        }
      ]
    },
    {
      "id": "phase-3-frontend-ui",
      "name": "Frontend UI Components",
      "type": "implementation",
      "description": "Create enhanced cancellation dialog with reason selection and rescheduling options",
      "depends_on": [
        "phase-2-server-actions"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Create emergency cancellation reason selector component",
          "service": "frontend",
          "files_to_create": [
            "components/worker/emergency-cancellation-dialog.tsx"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "components/worker/cancel-booking-dialog.tsx",
            "components/booking/worker-notes-dialog.tsx"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify component has: reason dropdown, note textarea, shows penalty info, submit button"
          },
          "status": "completed",
          "notes": "Created components/worker/emergency-cancellation-dialog.tsx with: (1) Reason dropdown with grouped categories (illness, family_emergency, personal_emergency, weather, transportation, schedule_conflict, other), (2) Note textarea with character count, (3) Penalty info display with color coding (green for 0%, yellow for 10%, orange for 25%+), (4) Submit button with loading state, (5) Error handling with user-friendly messages, (6) Controlled/uncontrolled dialog state following pattern from WorkerNotesDialog. Component fetches cancellation reasons on mount and calls cancelBookingWithReason on submit."
        },
        {
          "id": "subtask-3-2",
          "description": "Update booking card to use emergency cancellation dialog",
          "service": "frontend",
          "files_to_modify": [
            "components/worker/booking-card.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [
            "components/worker/booking-card.tsx"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify booking card shows emergency cancellation button for accepted/pending bookings"
          },
          "status": "completed",
          "notes": "Updated BookingCard to use EmergencyCancellationDialog instead of CancelBookingDialog. Added workerId prop to BookingCardProps. Extended canCancel to include both 'pending' and 'accepted' bookings. Added distinct UI for emergency cancellation (outline button with orange styling and alert icon for accepted bookings, standard destructive button for pending). Updated BookingList to pass workerId to BookingCard and removed unused cancelBooking function."
        },
        {
          "id": "subtask-3-3",
          "description": "Add business-side cancellation with notes",
          "service": "frontend",
          "files_to_modify": [
            "components/booking/worker-application-card.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [
            "components/booking/worker-notes-dialog.tsx"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify business can cancel accepted bookings with notes about cancellation"
          },
          "status": "completed",
          "notes": "Created WorkerCancellationDialog component following WorkerNotesDialog pattern with: (1) Dialog with AlertTriangle icon for visual warning, (2) Mandatory cancellation notes textarea with character count, (3) 'Keep Booking' and 'Cancel Booking' buttons with destructive styling, (4) Loading state during cancellation, (5) Controlled/uncontrolled dialog state support. Updated WorkerApplicationCard to add: (1) onCancelBooking prop, (2) Cancellation button (X icon) that appears next to status badge for accepted bookings, (3) Button only visible when status is 'accepted' and onCancelBooking is provided, (4) click handler properly stops propagation to prevent card selection."
        },
        {
          "id": "subtask-3-4",
          "description": "Update worker bookings page to handle cancellation",
          "service": "frontend",
          "files_to_modify": [
            "app/(dashboard)/worker/bookings/page.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [
            "app/(dashboard)/worker/bookings/page.tsx"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify page refreshes booking list after cancellation"
          },
          "status": "completed",
          "notes": "Verified worker bookings page refreshes booking list after cancellation. The implementation was already complete from previous subtasks: BookingList component has handleCancel callback that calls loadBookings(), which is passed through BookingCard to EmergencyCancellationDialog as onSuccess. When cancellation completes, onSuccess triggers handleCancel, which refreshes the bookings list. No code changes were needed to the page itself."
        }
      ]
    },
    {
      "id": "phase-4-integration",
      "name": "Integration & Testing",
      "type": "integration",
      "description": "Wire all components together, test end-to-end cancellation flow",
      "depends_on": [
        "phase-2-server-actions",
        "phase-3-frontend-ui"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "End-to-end test: Worker cancels with emergency reason",
          "all_services": true,
          "files_to_create": [
            "scripts/test-e2e-emergency-cancellation.ts",
            "scripts/test-e2e-emergency-cancellation.sh"
          ],
          "files_to_modify": [
            "package.json"
          ],
          "patterns_from": [
            "scripts/test-e2e-worker-withdrawal.ts"
          ],
          "verification": {
            "type": "e2e",
            "steps": [
              "Worker views accepted booking",
              "Worker clicks emergency cancel button",
              "Worker selects illness reason and adds note",
              "Booking status changes to cancelled",
              "Business receives notification",
              "Worker reliability score updated with minimal penalty"
            ]
          },
          "status": "completed",
          "notes": "Created comprehensive E2E test script (test-e2e-emergency-cancellation.ts) that verifies the complete worker emergency cancellation flow. Test covers: (1) Setup test data (worker, business, job, booking), (2) Verify worker views accepted booking, (3) Get illness cancellation reason with 0% penalty, (4) Simulate worker cancellation with reason and note, (5) Verify booking status changes to cancelled, (6) Verify business receives notification, (7) Verify worker reliability score calculation accounts for emergency cancellations with minimal penalty. Shell script wrapper and npm script added for easy execution. TypeScript compilation passes."
        },
        {
          "id": "subtask-4-2",
          "description": "End-to-end test: Business cancels worker booking",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Business views worker booking",
              "Business cancels with reason",
              "Worker receives notification",
              "Booking status changes to cancelled"
            ]
          },
          "status": "pending"
        },
        {
          "id": "subtask-4-3",
          "description": "Verify repeated cancellations affect reliability score",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Worker cancels multiple bookings",
              "Check reliability score calculation",
              "Verify penalty increases with repeated cancellations"
            ]
          },
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 4,
    "total_subtasks": 15,
    "services_involved": [
      "database",
      "frontend",
      "edge_functions"
    ],
    "parallelism": {
      "max_parallel_phases": 1,
      "parallel_groups": [],
      "recommended_workers": 1,
      "speedup_estimate": "Sequential execution required due to dependencies"
    },
    "startup_command": "npm run dev"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "unit",
      "integration"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "Database migration applies successfully",
      "Cancellation reasons are properly seeded",
      "Workers can cancel with emergency reasons",
      "Businesses can cancel with notes",
      "Notifications are sent to affected parties",
      "Reliability scores are updated appropriately",
      "UI components render without errors"
    ],
    "verification_steps": [
      {
        "name": "Database Migration",
        "command": "supabase db push",
        "expected_outcome": "Migration applies successfully",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Type Check",
        "command": "npm run type-check",
        "expected_outcome": "No TypeScript errors",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Build Verification",
        "command": "npm run build",
        "expected_outcome": "Build succeeds without errors",
        "type": "test",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "Medium risk change involving database schema changes, new server actions, and UI components. Requires database migration testing and type safety verification."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": false,
      "commands": [],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": [
        "npm run build"
      ],
      "services_to_test": [
        "frontend",
        "database"
      ]
    },
    "e2e_tests": {
      "required": true,
      "commands": [
        "Manual testing in browser"
      ],
      "flows": [
        "worker-emergency-cancellation",
        "business-cancellation-with-notes"
      ]
    },
    "browser_verification": {
      "required": true,
      "pages": [
        {
          "url": "http://localhost:3000/worker/bookings",
          "checks": [
            "cancellation dialog renders",
            "reason selector works"
          ]
        },
        {
          "url": "http://localhost:3000/business/jobs",
          "checks": [
            "booking management works"
          ]
        }
      ]
    },
    "database_verification": {
      "required": true,
      "checks": [
        "cancellation_reasons table exists",
        "bookings table has new columns",
        "RLS policies enabled"
      ]
    }
  },
  "qa_signoff": null,
  "planStatus": "in_progress",
  "xstateState": "backlog",
  "executionPhase": "coding"
}