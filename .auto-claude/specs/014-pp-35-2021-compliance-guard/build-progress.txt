# Build Progress - PP 35/2021 Compliance Guard

## Subtask 1-1: Create compliance_tracking table ✅ COMPLETED
- File: supabase/migrations/20260222_add_compliance_tracking.sql
- Status: COMPLETE - Migration file already exists with proper implementation
- Schema Verified:
  - id (UUID primary key with gen_random_uuid())
  - business_id (FK → businesses.id ON DELETE CASCADE)
  - worker_id (FK → workers.id ON DELETE CASCADE)
  - month (DATE - first day of month)
  - days_worked (INTEGER >= 0, DEFAULT 0)
  - created_at (TIMESTAMPTZ)
  - updated_at (TIMESTAMPTZ)
- Indexes Created:
  - idx_compliance_tracking_business_id
  - idx_compliance_tracking_worker_id
  - idx_compliance_tracking_month
  - idx_compliance_tracking_business_worker_month (composite)
- Constraints:
  - UNIQUE(business_id, worker_id, month)
  - CHECK (days_worked >= 0)
- RLS Policies:
  - "Businesses can view own compliance tracking" (SELECT)
  - "Workers can view own compliance tracking" (SELECT)
  - "Admins can view all compliance tracking data" (SELECT)
  - "Authenticated users can insert compliance tracking data" (INSERT)
  - "Authenticated users can update compliance tracking data" (UPDATE)
- Trigger: set_compliance_tracking_updated_at (auto-updates updated_at)

## Subtask 1-2: Create calculate_days_worked function ✅ COMPLETED
- File: supabase/migrations/20260222_add_compliance_tracking.sql
- Status: COMPLETE - Function implemented following project patterns
- Function: calculate_days_worked(p_business_id, p_worker_id, p_month)
  - Returns: INTEGER (count of accepted/completed bookings in specified month)
  - Logic: Counts bookings where status IN ('accepted', 'completed') and start_date within month
  - Error Handling: Returns 0 on failure with RAISE WARNING
  - Uses: SECURITY DEFINER for proper permissions
  - Documentation: COMMENT added describing purpose and usage

## Subtask 1-3: Create trigger for automatic compliance_tracking updates ✅ COMPLETED
- File: supabase/migrations/20260222_add_compliance_tracking.sql
- Status: COMPLETE - Trigger implemented following project patterns
- Function: update_compliance_tracking_for_booking()
  - Trigger: AFTER INSERT OR UPDATE ON bookings
  - Logic:
    - Fires when booking status changes to 'accepted' or 'completed'
    - Calculates month from start_date (fallback to created_at)
    - Calls calculate_days_worked() to get current count
    - Upserts into compliance_tracking using ON CONFLICT
  - Error Handling: Returns NEW/OLD to prevent booking failures
  - Documentation: COMMENT added for function and trigger
- Trigger Name: on_booking_status_change_for_compliance

## Subtask 1-4: Add RLS policies for compliance_tracking table ✅ COMPLETED
- File: supabase/migrations/20260222_add_compliance_tracking.sql
- Status: COMPLETE - RLS policies implemented following project patterns
- Policies Created:
  - "Workers can view their own compliance tracking" (SELECT)
    - Workers can only view records where worker_id matches their worker profile
  - "Businesses can view their compliance tracking" (SELECT)
    - Businesses can only view records where business_id matches their business profile
  - "Admins can view all compliance tracking" (SELECT)
    - Admins can view all compliance tracking records for auditing
  - "Admins can update any compliance tracking" (UPDATE)
    - Admins can modify any compliance tracking record for moderation
  - "Admins can delete any compliance tracking" (DELETE)
    - Admins can delete any compliance tracking record for moderation
- Security Model:
  - Workers and businesses have read-only access (SELECT only)
  - No INSERT/UPDATE policies for regular users - data is maintained via triggers
  - Admins have full access for auditing and dispute resolution
- Pattern Compliance: Follows the same structure as 20260222_add_bookings_rls_policies.sql

## Subtask 2-1: Create getWorkerDaysForMonth query function ✅ COMPLETED
- File: lib/supabase/queries/compliance.ts (NEW FILE)
- Status: COMPLETE - Query function implemented following project patterns
- Functions Created:
  - getWorkerDaysForMonth(workerId, businessId, month)
    - Calls database function calculate_days_worked via RPC
    - Returns days worked count (default 0 if no record)
    - Error handling with try-catch and console.error
  - getBusinessComplianceRecords(businessId, limit)
    - Returns all compliance records for a business with worker details
    - Useful for auditing and compliance history
  - getWorkerComplianceRecords(workerId, limit)
    - Returns all compliance records for a worker with business details
    - Useful for workers to track their work history
- Pattern Compliance: Follows the same structure as lib/supabase/queries/bookings.ts
- TypeScript Verification: No new TypeScript errors introduced
- Note: Uses type assertion for database function call until types are regenerated

## Subtask 2-2: Create getComplianceStatus query function ✅ COMPLETED
- File: lib/supabase/queries/compliance.ts
- Status: COMPLETE - Query function implemented following project patterns
- Functions Created:
  - getComplianceStatus(workerId, businessId, month?)
    - Checks if worker can be booked based on PP 35/2021 compliance rules
    - Returns ComplianceStatusResult with:
      - status: 'ok' | 'warning' | 'blocked'
      - daysWorked: number
      - warningLevel: 'none' | 'approaching' | 'limit'
      - message: string (descriptive message)
    - Logic:
      - Days 0-14: OK (can book)
      - Days 15-20: Warning (approaching limit, can still book)
      - Day 21+: Blocked (cannot book - PP 35/2021 limit)
    - Defaults to current month if not provided
- Type Exports Added:
  - ComplianceStatus: 'ok' | 'warning' | 'blocked'
  - WarningLevel: 'none' | 'approaching' | 'limit'
  - ComplianceStatusResult: interface for return value
- Pattern Compliance: Follows the same structure as lib/supabase/queries/bookings.ts
- TypeScript Verification: No new TypeScript errors introduced

## Subtask 2-3: Create getComplianceRecords query function ✅ COMPLETED
- File: lib/supabase/queries/compliance.ts
- Status: COMPLETE - Query function implemented following project patterns
- Functions Created:
  - getComplianceRecords(businessId, limit)
    - Returns all compliance records for a business with worker details
    - Used for audit purposes to track worker compliance history
    - Same as getBusinessComplianceRecords (audit-focused alias)
- Pattern Compliance: Follows the same structure as lib/supabase/queries/bookings.ts
- TypeScript Verification: No new TypeScript errors introduced

## Subtask 2-4: Create getAlternativeWorkers query function ✅ COMPLETED
- File: lib/supabase/queries/compliance.ts
- Status: COMPLETE - Query function implemented following project patterns
- Functions Created:
  - getAlternativeWorkers(businessId, month?, limit)
    - Returns workers who haven't reached the 21-day PP 35/2021 limit
    - Returns AlternativeWorker[] with:
      - Worker details: id, full_name, avatar_url, phone, bio
      - Compliance info: daysWorked, complianceStatus, warningLevel
    - Logic:
      - Fetches all workers from database
      - Checks compliance status for each worker
      - Filters out blocked workers (21+ days)
      - Sorts by availability (days worked ascending)
      - Limits results to specified number (default: 20)
    - Defaults to current month if not provided
- Type Exports Added:
  - AlternativeWorker: interface for worker with compliance info
  - WorkerRow: type alias for Database['public']['Tables']['workers']['Row']
- Pattern Compliance: Follows the same structure as lib/supabase/queries/bookings.ts
- TypeScript Verification: No compliance-related TypeScript errors

## Subtask 3-1: Create checkComplianceBeforeAccept server action ✅ COMPLETED
- File: lib/actions/compliance.ts (NEW FILE)
- Status: COMPLETE - Server action implemented following project patterns
- Actions Created:
  - checkComplianceBeforeAccept(workerId, businessId, month?)
    - Verifies worker can be accepted before booking
    - Returns ComplianceCheckResult with:
      - success: boolean
      - canAccept: boolean (false if worker is blocked)
      - error?: string
      - data?: ComplianceStatusResult
    - Logic:
      - Verifies business exists
      - Verifies worker exists
      - Calls getComplianceStatus query function
      - Determines canAccept based on compliance status (blocked = cannot accept)
    - Uses Indonesian error messages (following job-applications.ts pattern)
  - getBusinessComplianceRecordsForAudit(businessId, limit)
    - Retrieves compliance records for a business for audit purposes
    - Returns records with worker details (full_name, avatar_url)
- Type Exports Added:
  - ComplianceCheckResult: interface for return value
- Pattern Compliance:
  - Uses "use server" directive
  - Imports createClient from "../supabase/server"
  - Returns { success, error?, data? } format
  - Uses Indonesian error messages
- TypeScript Verification: No compliance-related TypeScript errors
- Git Commit: d301c15 "auto-claude: subtask-3-1 - Create checkComplianceBeforeAccept server action"

## Subtask 3-2: Update acceptApplication action to check compliance ✅ COMPLETED
- File: lib/actions/job-applications.ts
- Status: COMPLETE - acceptApplication now checks compliance before accepting
- Changes Made:
  - Added import: checkComplianceBeforeAccept from "./compliance"
  - Updated acceptApplication function:
    - Fetches booking first to get worker_id
    - Calls checkComplianceBeforeAccept(booking.worker_id, businessId)
    - Blocks acceptance if canAccept is false
    - Returns Indonesian error message with days worked count
    - Error message: "Pekerja telah mencapai batas 21 hari kerja dalam sebulan sesuai PP 35/2021 (${daysWorked} hari). Tidak dapat menerima lamaran."
  - Updated JSDoc comment to mention compliance check
- Pattern Compliance:
  - Follows existing error handling pattern
  - Uses Indonesian error messages
  - Preserves existing function logic flow
  - Returns { success, error?, data? } format
- Manual Verification:
  - Function calls checkComplianceBeforeAccept before accepting
  - Blocks acceptance when limit is reached
  - Informative error message includes days worked
- Git Commit: e10fe04 "auto-claude: subtask-3-2 - Update acceptApplication action to check compliance"

## Subtask 4-1: Create ComplianceWarningBanner component ✅ COMPLETED
- File: components/booking/compliance-warning-banner.tsx (NEW FILE)
- Status: COMPLETE - Banner component implemented following project patterns
- Component Features:
  - ComplianceWarningBanner({ className?, compliance, onViewAlternatives? })
    - Returns null when status is 'ok' (no banner needed)
    - Displays amber/yellow warning for 15-20 days (approaching limit)
    - Displays red/blocked state for 21+ days (PP 35/2021 limit reached)
    - Shows current days worked and remaining days
    - Optional "View Alternatives" button for blocked state
  - Style System:
    - Blocked: Red colors (border-red-200 bg-red-50 dark:border-red-900 dark:bg-red-950)
    - Warning: Amber colors matching JobDraftBanner (border-amber-200 bg-amber-50 dark:border-amber-800 dark:bg-amber-950)
    - Responsive: flex-col on mobile, flex-row on sm+
  - Props Interface:
    - ComplianceStatusResult imported from lib/supabase/queries/compliance
    - className for custom styling
    - onViewAlternatives optional callback
- Pattern Compliance:
  - Follows JobDraftBanner structure (app/components/job-draft-banner.tsx)
  - Uses cn() utility from lib/utils
  - Uses Button from components/ui/button
  - "use client" directive for client component
  - Proper TypeScript types and interfaces
- TypeScript Verification: No compliance-related TypeScript errors
- Git Commit: 0d3e38a "auto-claude: subtask-4-1 - Create ComplianceWarningBanner component to show warnings when approaching limits"

## Subtask 4-2: Create ComplianceStatusBadge component ✅ COMPLETED
- File: components/booking/compliance-status-badge.tsx (NEW FILE)
- Status: COMPLETE - Badge component implemented following project patterns
- Component Features:
  - ComplianceStatusBadge({ compliance, showDays?, showIcon?, size?, className? })
    - Displays compliance status as a badge with icon and optional days count
    - Status variants:
      - 'ok' → Outline badge with CheckCircle2 icon (green styling implied)
      - 'warning' → Custom amber/yellow badge with AlertCircle icon
      - 'blocked' → Destructive (red) badge with XCircle icon
    - Shows days worked as "({daysWorked}/21)" when showDays=true
    - Configurable icon visibility with showIcon prop
    - Size variants: "sm" (px-2 py-0.5) or "md" (px-2.5 py-1)
  - Props Interface:
    - compliance: ComplianceStatusResult (imported from lib/supabase/queries/compliance)
    - showDays: boolean (default: true)
    - showIcon: boolean (default: true)
    - size: "sm" | "md" (default: "sm")
    - className for custom styling
  - Icons from lucide-react:
    - CheckCircle2 for 'ok' status
    - AlertCircle for 'warning' status
    - XCircle for 'blocked' status
- Pattern Compliance:
  - Follows WorkerApplicationCard.tsx patterns for status badges
  - Uses statusVariants record pattern for status configuration
  - Uses Badge from components/ui/badge with variant prop
  - Uses cn() utility from lib/utils for conditional classes
  - "use client" directive for client component
  - Proper TypeScript types and exported interfaces
- TypeScript Verification: No compliance-related TypeScript errors
- Git Commit: d341674 "auto-claude: subtask-4-2 - Create ComplianceStatusBadge component to display worker compliance status in applicant cards"

## Subtask 4-3: Create AlternativeWorkersSuggestion component ✅ COMPLETED
- File: components/booking/alternative-workers-suggestion.tsx (NEW FILE)
- Status: COMPLETE - Alternative workers suggestion component implemented following project patterns
- Component Features:
  - AlternativeWorkersSuggestion({ workers, isLoading?, onSelectWorker?, className? })
    - Displays loading state with Alert while fetching workers
    - Shows empty state Alert when no workers available (all at limit)
    - Shows informative Alert with worker count when workers available
    - Grid layout: 1 column on mobile, 2 on md, 3 on lg screens
    - Workers sorted by availability (fewest days worked first)
  - AlternativeWorkerCard subcomponent:
    - Card-based layout matching WorkerApplicationCard pattern
    - Avatar with fallback initials
    - Worker full name and bio
    - Phone number with clickable tel: link
    - DaysWorkedBadge showing "X days this month" with color coding:
      - Green (15-17 days): secondary badge
      - Yellow (18-20 days): outline badge
      - Amber (0-14 days): default badge
    - Compliance status section showing "Available for booking this month"
  - Helper Components:
    - ReliabilityScore: Reusable star rating component (from WorkerApplicationCard)
    - DaysWorkedBadge: Badge showing days worked with color coding
  - Props Interface:
    - workers: AlternativeWorker[] (imported from lib/supabase/queries/compliance)
    - isLoading: boolean (default: false)
    - onSelectWorker: optional callback function
    - className for custom styling
- Type Exports Added:
  - AlternativeWorkersSuggestionProps: interface for component props
- Pattern Compliance:
  - Follows WorkerApplicationCard patterns exactly (components/booking/worker-application-card.tsx)
  - Uses Card, CardContent, CardHeader, CardTitle from components/ui/card
  - Uses Badge from components/ui/badge
  - Uses Avatar, AvatarFallback, AvatarImage from components/ui/avatar
  - Uses Alert, AlertDescription, AlertTitle from components/ui/alert
  - Uses Icons from lucide-react (Users, AlertCircle, Calendar, Phone, Star)
  - Uses cn() utility from lib/utils
  - "use client" directive for client component
  - Proper TypeScript types and exported interfaces
  - Follows accessibility patterns (aria-labels, semantic HTML)
- TypeScript Verification: No compliance-related TypeScript errors (pre-existing errors unrelated to this component)
- Git Commit: 14618ba "auto-claude: subtask-4-3 - Create AlternativeWorkersSuggestion component"

## Quality Checklist ✅
- [x] Follows patterns from reference files (initial_schema.sql, kyc_verifications.sql, bookings.ts)
- [x] No console.log/print debugging statements
- [x] Proper foreign key relationships (businesses, workers tables exist)
- [x] Error handling in place (RLS policies, constraints, exception handling)
- [x] Clean commits with descriptive messages
