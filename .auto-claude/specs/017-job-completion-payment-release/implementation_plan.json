{
  "feature": "Job Completion & Payment Release",
  "description": "# Job Completion & Payment Release\n\nAutomated job completion workflow that triggers when workers check out. Moves funds from business pending balance to worker pending balance, then to worker available balance after review period or auto-release timer.\n\n## Rationale\nAutomated payment release ensures workers are paid fairly and quickly while giving businesses a window to raise issues. This builds trust and reduces payment disputes.\n\n## User Stories\n- As a worker, I want to be paid automatically after completing a job so that I receive my earnings promptly\n- As a business, I want a review period so that I can flag issues if needed\n- As both parties, I want payment confirmation so that I know the transaction completed\n\n## Acceptance Criteria\n- [ ] Job completion is triggered when worker checks out\n- [ ] Payment moves from business pending to worker pending\n- [ ] Businesses can flag issues within 24 hours\n- [ ] Worker funds are released after 24-hour review period\n- [ ] Payment confirmation notifications are sent to both parties\n- [ ] Transaction records show payment flow\n- [ ] Disputed payments are held until resolution\n",
  "created_at": "2026-02-21T21:14:31.161Z",
  "updated_at": "2026-02-22T17:45:01.977Z",
  "status": "in_progress",
  "planStatus": "in_progress",
  "xstateState": "backlog",
  "executionPhase": "coding",
  "workflow_type": "feature",
  "workflow_rationale": "This is a multi-service feature requiring database schema changes, backend business logic (server actions), and UI components. The feature involves multiple tables (bookings, wallets, transactions) and flows (checkout -> payment hold -> review -> release). A feature workflow with service dependency phases is appropriate.",
  "phases": [
    {
      "id": "phase-1-database",
      "name": "Database Schema & RLS Policies",
      "type": "setup",
      "description": "Create database tables for wallets, balances, disputes, and add job completion fields to bookings table. Implement RLS policies for security.",
      "depends_on": [],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Create migration for wallet tables and booking completion fields",
          "service": "database",
          "files_to_create": [
            "supabase/migrations/20260222_add_job_completion_payment_schema.sql"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "supabase/migrations/20250222000001_initial_schema.sql"
          ],
          "verification": {
            "type": "command",
            "command": "psql $DATABASE_URL -c \"\\dt\" | grep -E 'wallets|wallet_transactions|disputes'",
            "expected": "wallets, wallet_transactions, disputes"
          },
          "status": "completed"
        },
        {
          "id": "subtask-1-2",
          "description": "Create RLS policies for wallet tables and payment operations",
          "service": "database",
          "files_to_create": [
            "supabase/migrations/20260222_add_payment_rls_policies.sql"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "supabase/migrations/20260222_add_bookings_rls_policies.sql"
          ],
          "verification": {
            "type": "command",
            "command": "psql $DATABASE_URL -c \"SELECT schemaname, tablename FROM pg_policies WHERE tablename IN ('wallets', 'wallet_transactions', 'disputes');\"",
            "expected": "Multiple RLS policies for each table"
          },
          "status": "completed"
        },
        {
          "id": "subtask-1-3",
          "description": "Update TypeScript types to reflect new schema",
          "service": "app",
          "files_to_modify": [
            "lib/supabase/types.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "lib/supabase/types.ts"
          ],
          "verification": {
            "type": "command",
            "command": "npm run type-check",
            "expected": "No TypeScript errors"
          },
          "status": "completed",
          "notes": "TypeScript types in lib/supabase/types.ts already include all new tables (wallets, wallet_transactions, disputes) and updated bookings table fields (checkout_time, payment_status, review_deadline). No type errors related to the new schema.",
          "updated_at": "2026-02-22T14:38:24.110954+00:00"
        }
      ]
    },
    {
      "id": "phase-2-backend-wallet",
      "name": "Wallet System Backend",
      "type": "implementation",
      "description": "Implement wallet and balance management server actions and queries. Workers can view pending and available balances.",
      "depends_on": [
        "phase-1-database"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Create wallet query functions (get balance, create wallet, transactions)",
          "service": "app",
          "files_to_create": [
            "lib/supabase/queries/wallets.ts"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "lib/lib/supabase/queries/bookings.ts"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify functions follow existing query pattern with proper error handling and return types"
          },
          "status": "completed",
          "notes": "Wallet query functions already implemented in lib/supabase/queries/wallets.ts. File includes all required functions: getWalletBalance, createWallet, getWalletTransactions, plus additional helper functions like getWalletByUserId, getOrCreateWallet, updateWalletBalance, addPendingFunds, releaseFunds, deductAvailableFunds, getUserWalletTransactions, createWalletTransaction, getTransactionsByBookingId, updateTransactionStatus. All functions follow the pattern from bookings.ts with proper error handling, type definitions, and JSDoc comments. No code changes needed - implementation was already complete.",
          "updated_at": "2026-02-22T15:15:44.322633+00:00"
        },
        {
          "id": "subtask-2-2",
          "description": "Create wallet server actions (create wallet, get balance, add funds, release funds)",
          "service": "app",
          "files_to_create": [
            "lib/actions/wallets.ts"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "lib/actions/job-applications.ts",
            "lib/actions/notifications.ts"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify 'use server' directive and {success, error?, data?} return pattern"
          },
          "status": "completed",
          "notes": "Created lib/actions/wallets.ts with 8 server action functions following patterns from job-applications.ts and notifications.ts. All functions use \"use server\" directive, proper TypeScript types, and {success, error?, data?} return pattern. Includes: createWalletAction, getWalletBalanceAction, getOrCreateWalletAction, addPendingFundsAction, releaseFundsAction, deductAvailableFundsAction, getWalletTransactionsAction, getWalletDetailsAction. TypeScript type check shows no errors for this file.",
          "updated_at": "2026-02-22T15:20:37.786672+00:00"
        },
        {
          "id": "subtask-2-3",
          "description": "Create wallet hook for React components",
          "service": "app",
          "files_to_create": [
            "lib/hooks/useWallet.ts"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "lib/hooks/use-bookings.ts"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify hook follows existing pattern with loading, error states"
          },
          "status": "completed",
          "notes": "Wallet hook already implemented in lib/hooks/useWallet.ts. File follows the pattern from use-bookings.ts: uses 'use client' directive, proper TypeScript types (UseWalletOptions, UseWalletReturn), useState/useEffect/useCallback hooks, toast notifications for success/error messages, autoFetch option, and proper error handling. Hook provides comprehensive wallet functionality including fetchWallet, fetchWalletBalance, fetchTransactions, initializeWallet, addFundsToPending, releasePendingFunds, withdrawFunds, and refreshWallet methods. No console.log statements present.",
          "updated_at": "2026-02-23T00:00:00.000000+00:00"
        }
      ]
    },
    {
      "id": "phase-3-backend-checkout",
      "name": "Checkout & Payment Release Backend",
      "type": "implementation",
      "description": "Implement worker checkout functionality, payment hold/release workflow, and dispute system.",
      "depends_on": [
        "phase-2-backend-wallet"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Add checkout server action - marks booking complete, initiates payment hold",
          "service": "app",
          "files_to_create": [
            "lib/actions/bookings.ts"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "lib/actions/job-applications.ts"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify checkout updates booking status, sets review_deadline, and creates pending wallet entry"
          },
          "status": "completed",
          "notes": "Created lib/actions/bookings.ts with checkoutBooking function that: 1) Verifies booking belongs to worker and is in_progress, 2) Marks booking as completed with checkout_time, 3) Sets review_deadline to 24 hours from now, 4) Sets payment_status to pending_review, 5) Initiates payment hold in worker's wallet using addPendingFundsAction. Also includes helper functions: getWorkerBooking, getBusinessBooking, getWorkerBookings, getBusinessBookings. All functions follow patterns from job-applications.ts with proper error handling, TypeScript types, and Indonesian error messages.",
          "updated_at": "2026-02-23T00:00:00.000000+00:00"
        },
        {
          "id": "subtask-3-2",
          "description": "Add payment release function - moves funds from pending to available after review period",
          "service": "app",
          "files_to_create": [
            "lib/actions/payments.ts"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "lib/actions/wallets.ts"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify release checks review deadline and updates payment status to 'available'"
          },
          "status": "completed",
          "notes": "Payment release functions already implemented in lib/actions/payments.ts. File includes: 1) releasePaymentAction - Releases single booking payment after verifying review deadline passed, 2) releaseDuePaymentsAction - Batch releases all due payments for cron job, 3) getPendingReleasePaymentsAction - Gets pending payments with release countdown. All functions follow patterns from wallets.ts with proper error handling, TypeScript types, Indonesian error messages, and {success, error?, data?} return pattern. Reviews deadline check ensures funds are only released when review period expires.",
          "updated_at": "2026-02-23T00:00:00.000000+00:00"
        },
        {
          "id": "subtask-3-3",
          "description": "Add dispute functionality - allows business to flag issues and hold payment",
          "service": "app",
          "files_to_create": [
            "lib/actions/disputes.ts",
            "lib/supabase/queries/disputes.ts"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "lib/actions/job-applications.ts",
            "lib/lib/supabase/queries/bookings.ts"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify dispute creation updates payment status and prevents auto-release"
          },
          "status": "completed",
          "notes": "Created lib/supabase/queries/disputes.ts with 8 query functions following patterns from jobs.ts and wallets.ts: getDisputeById, getDisputesByBookingId, getBusinessDisputes, getWorkerDisputes, getPendingDisputes, createDispute, updateDisputeStatus, updateDisputeResolution, checkActiveDispute. The lib/actions/disputes.ts already existed with comprehensive dispute functionality including raiseDispute, raiseDisputeByWorker, getDispute, getBusinessDisputes, getWorkerDisputes, resolveDispute, checkActiveDispute, getPendingDisputes. Dispute creation correctly updates booking payment_status to 'disputed' and wallet transaction status to 'disputed', which prevents auto-release via the payment release logic.",
          "updated_at": "2026-02-23T01:27:00.000000+00:00"
        },
        {
          "id": "subtask-3-4",
          "description": "Update booking queries to include payment status and timestamps",
          "service": "app",
          "files_to_modify": [
            "lib/lib/supabase/queries/bookings.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "lib/lib/supabase/queries/bookings.ts"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify queries return checkout time, payment status, and wallet info"
          },
          "status": "completed",
          "notes": "Updated lib/lib/supabase/queries/bookings.ts to include payment status and wallet information in all booking queries. Modified JobBookingWithDetails type to include optional wallet_transaction field. Updated getJobBookings, getWorkerBookings, getBusinessBookings, and getBookingById functions to fetch wallet transaction details (id, amount, type, status, description, created_at). All booking queries already return checkout_time, payment_status, and review_deadline fields via select('*'). Now queries provide complete payment information including transaction details.",
          "updated_at": "2026-02-22T17:33:09.002585+00:00"
        }
      ]
    },
    {
      "id": "phase-4-frontend-checkout",
      "name": "Checkout UI Components",
      "type": "implementation",
      "description": "Create UI components for worker checkout flow, payment status display, and business dispute options.",
      "depends_on": [
        "phase-3-backend-checkout"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Create checkout dialog component for workers to confirm job completion",
          "service": "app",
          "files_to_create": [
            "components/booking/checkout-dialog.tsx"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "components/booking/worker-notes-dialog.tsx",
            "components/booking/booking-actions.tsx"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify dialog appears on accepted/in_progress bookings, shows job details, and confirms checkout"
          },
          "status": "completed",
          "notes": "Created checkout-dialog.tsx with: Job details display (title, description, payment estimate, work period, location), 24-hour review period notice, Controlled/uncontrolled state support, Integration with checkoutBooking server action, Indonesian language UI, Toast notifications, Proper loading and error states. Component follows patterns from WorkerNotesDialog and BookingActions. Only allows checkout for 'in_progress' status bookings.",
          "updated_at": "2026-02-23T01:37:00.000000+00:00"
        },
        {
          "id": "subtask-4-2",
          "description": "Create payment status badge showing payment state (pending/review/available/released)",
          "service": "app",
          "files_to_create": [
            "components/booking/payment-status-badge.tsx"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "components/worker/kyc-status-badge.tsx"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify badge shows correct colors and labels for each payment status"
          },
          "status": "completed",
          "notes": "Created components/booking/payment-status-badge.tsx following the exact pattern from kyc-status-badge.tsx. Supports 4 payment states: pending (yellow), review (blue), available (green), released (gray). Uses class-variance-authority for variants, proper TypeScript types, and includes dark mode support.",
          "updated_at": "2026-02-23T01:45:00.000000+00:00"
        },
        {
          "id": "subtask-4-3",
          "description": "Create dispute dialog for businesses to flag issues before payment release",
          "service": "app",
          "files_to_create": [
            "components/booking/dispute-dialog.tsx"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "components/booking/worker-notes-dialog.tsx"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify dialog allows reason input and only shows for bookings in review period"
          },
          "status": "pending"
        },
        {
          "id": "subtask-4-4",
          "description": "Update worker jobs page to show checkout button and payment status",
          "service": "app",
          "files_to_modify": [
            "app/(dashboard)/worker/jobs/page.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [
            "app/(dashboard)/worker/jobs/page.tsx"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000/dashboard/worker/jobs",
            "checks": [
              "Checkout button appears for accepted/in_progress bookings",
              "Payment status displays correctly"
            ]
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-5-frontend-wallet",
      "name": "Wallet UI Components",
      "type": "implementation",
      "description": "Create wallet dashboard showing pending and available balances with transaction history.",
      "depends_on": [
        "phase-2-backend-wallet"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Create wallet balance card component showing pending and available funds",
          "service": "app",
          "files_to_create": [
            "components/wallet/wallet-balance-card.tsx"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "components/ui/card.tsx"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify card displays pending and available balances separately with proper formatting"
          },
          "status": "pending"
        },
        {
          "id": "subtask-5-2",
          "description": "Create wallet summary section with total earnings and release countdown",
          "service": "app",
          "files_to_create": [
            "components/wallet/wallet-summary.tsx"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "components/wallet/wallet-balance-card.tsx"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify summary shows time until funds are available and total earnings"
          },
          "status": "pending"
        },
        {
          "id": "subtask-5-3",
          "description": "Create transaction history list component",
          "service": "app",
          "files_to_create": [
            "components/wallet/transaction-history.tsx"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "components/job-marketplace/JobList.tsx"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify list shows all wallet transactions with timestamps and amounts"
          },
          "status": "pending"
        },
        {
          "id": "subtask-5-4",
          "description": "Create wallet page for workers to view balances and transactions",
          "service": "app",
          "files_to_create": [
            "app/(dashboard)/worker/wallet/page.tsx"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "app/(dashboard)/worker/jobs/page.tsx"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000/dashboard/worker/wallet",
            "checks": [
              "Wallet balance displays",
              "Transaction history loads",
              "No console errors"
            ]
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-6-integration",
      "name": "Integration & End-to-End Testing",
      "type": "integration",
      "description": "Wire all components together, test full payment flow from checkout to release, and add notification integrations.",
      "depends_on": [
        "phase-4-frontend-checkout",
        "phase-5-frontend-wallet"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-6-1",
          "description": "Add payment notifications to checkout and payment release flows",
          "service": "app",
          "files_to_modify": [
            "lib/actions/bookings.ts",
            "lib/actions/payments.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "lib/actions/notifications.ts"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify notifications are sent: checkout confirmation, payment available, payment released"
          },
          "status": "pending"
        },
        {
          "id": "subtask-6-2",
          "description": "End-to-end test: Worker checkout -> Business sees review period -> Payment auto-releases",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Worker accepts booking -> status becomes 'accepted'",
              "Business starts job -> status becomes 'in_progress'",
              "Worker checks out -> status becomes 'completed', payment in 'pending_review'",
              "Business sees 24-hour review period countdown",
              "After 24 hours, payment auto-releases to 'available'",
              "Worker wallet shows available balance increase",
              "Both parties receive payment notifications"
            ]
          },
          "status": "pending"
        },
        {
          "id": "subtask-6-3",
          "description": "End-to-end test: Business creates dispute during review period",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Worker checks out from job",
              "Business opens booking within review period",
              "Business clicks 'Report Issue' and submits dispute",
              "Payment status changes to 'disputed'",
              "Funds remain held, no auto-release occurs",
              "Worker sees dispute notification"
            ]
          },
          "status": "pending"
        },
        {
          "id": "subtask-6-4",
          "description": "Update business jobs page to show completed bookings with payment status",
          "service": "app",
          "files_to_modify": [
            "app/(dashboard)/business/jobs/page.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [
            "app/(dashboard)/business/jobs/page.tsx"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000/dashboard/business/jobs",
            "checks": [
              "Completed bookings show payment status",
              "Dispute button available during review period"
            ]
          },
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 6,
    "total_subtasks": 22,
    "services_involved": [
      "database",
      "app"
    ],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": [
            "phase-4-frontend-checkout",
            "phase-5-frontend-wallet"
          ],
          "reason": "Both depend on backend but are independent - checkout UI vs wallet UI"
        }
      ],
      "recommended_workers": 1,
      "speedup_estimate": "Limited parallelism due to phase dependencies - sequential is safer"
    },
    "startup_command": "npm run dev"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "manual"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "Worker can check out from completed job",
      "Payment moves to worker pending balance with 24-hour review period",
      "Business can dispute payment within review period",
      "Payment auto-releases to available balance after review period",
      "Both parties receive notifications at key stages",
      "Wallet displays pending and available balances",
      "Transaction history shows all payment movements"
    ],
    "verification_steps": [
      {
        "name": "TypeScript Type Check",
        "command": "npm run type-check",
        "expected_outcome": "No TypeScript errors",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Database Schema Verification",
        "command": "psql $DATABASE_URL -c \"SELECT tablename FROM pg_tables WHERE schemaname='public' AND tablename IN ('wallets', 'wallet_transactions', 'disputes');\"",
        "expected_outcome": "wallets, wallet_transactions, disputes tables exist",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "RLS Policies Verification",
        "command": "psql $DATABASE_URL -c \"SELECT COUNT(*) FROM pg_policies WHERE tablename IN ('wallets', 'wallet_transactions', 'disputes');\"",
        "expected_outcome": "Multiple RLS policies exist for new tables",
        "type": "test",
        "required": true,
        "blocking": false
      }
    ],
    "reasoning": "Medium risk feature involving financial transactions. Requires type safety and database security but no automated test framework exists - manual E2E verification is appropriate."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": false,
      "commands": [],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": false,
      "commands": [],
      "services_to_test": []
    },
    "e2e_tests": {
      "required": true,
      "commands": [],
      "flows": [
        "worker-checkout-payment-flow",
        "business-dispute-payment-flow"
      ]
    },
    "browser_verification": {
      "required": true,
      "pages": [
        {
          "url": "http://localhost:3000/dashboard/worker/jobs",
          "checks": [
            "Checkout button visible",
            "Payment status displays"
          ]
        },
        {
          "url": "http://localhost:3000/dashboard/worker/wallet",
          "checks": [
            "Balance loads",
            "Transaction history shows"
          ]
        },
        {
          "url": "http://localhost:3000/dashboard/business/jobs",
          "checks": [
            "Completed bookings visible",
            "Dispute option available"
          ]
        }
      ]
    },
    "database_verification": {
      "required": true,
      "checks": [
        "wallets-table-exists",
        "wallet_transactions-table-exists",
        "disputes-table-exists",
        "rls-policies-enabled",
        "booking-fields-added"
      ]
    }
  },
  "qa_signoff": null,
  "last_updated": "2026-02-22T17:33:09.002604+00:00"
}